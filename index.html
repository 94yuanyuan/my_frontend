<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>倉儲系統首頁</title>
  <script src="https://unpkg.com/petite-vue" defer init></script>
</head>
<style>
  .message {
    color: red;
  }

  .product-block {
    margin-bottom: 1em;
  }

  .product-summary {
    font-weight: bold;
    cursor: pointer;
  }

  .stock-table {
    width: 100%;
    margin-top: 0.5em;
    border-collapse: collapse;
  }

  .stock-table th,
  .stock-table td {
    padding: 5px;
    border-bottom: 1px solid #ccc;
  }

  .stock-table thead {
    background-color: #f0f0f0;
  }

  .text-right {
    text-align: right;
  }

  .bold {
    font-weight: bold;
  }
</style>
<body>
  <h1>歡迎使用我的倉儲系統</h1>
  <p>此網站尚在開發中...</p>

  <div v-scope="{
    page: 'login',
    username: '',
    password: '',
    message: '',
    isTestMode: new URLSearchParams(location.search).get('testMode') === '1',
    isLoading: false, // <== 新增鎖定變數

    // === 工具函式 ===
    getApiUrl(path) {
      return this.isTestMode
        ? 'https://my-backend-9pkr.onrender.com/404'
        : `https://my-backend-9pkr.onrender.com${path}`;
    },

    showError(err, fallback = '無法連線到伺服器，請檢查網路或稍後再試') {
      console.error('錯誤:', err);
      this.message = fallback;
    },

    // === 功能區 ===
    async login() {
      if (this.isLoading) return; // <== 防止重複點擊
      this.isLoading = true;	  // 鎖定按鈕
      this.message = '';		  // 清空錯誤訊息

      try {
        const res = await fetch(this.getApiUrl('/login'), {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            username: this.username.trim(),
            password: this.password
          })
        });

		// 捕捉 API 拋出的錯誤
        if (!res.ok) {
          this.message = `伺服器錯誤 (${res.status})，請稍後再試`;
          return;
        }

        const result = await res.json();
        this.message = result.message;
        if (result.success) {
          this.password = '';
          this.page = 'dashboard';
        }

      } catch (err) {
        this.showError(err);
      } finally {
        this.isLoading = false; // 無論成功與否都解鎖
      }
    },

    logout() {
      this.page = 'login';
      this.username = '';
      this.password = '';
      this.message = '';
    },

	products: [],
	inventory: [],
	stockList: [],
    async srcProducts() {
      this.message = ''; // 清空錯誤訊息

      try {
        const res = await fetch(this.getApiUrl('/api/products?limit=3'), {
          method: 'GET'
        });

        if (!res.ok) {
          this.message = `伺服器錯誤 (${res.status})，請稍後再試`;
          return;
        }

        const result = await res.json();
        this.products = result;

      } catch (err) {
        this.showError(err);
      }

      try {
		const productCodes = this.products.map(p => p.productCode);
        const res = await fetch(this.getApiUrl('/api/inventory/by-products'), {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            productCodes
          })
        });

        if (!res.ok) {
          this.message = `伺服器錯誤 (${res.status})，請稍後再試`;
          return;
        }

        result = await res.json();
		this.inventory = result;

	  } catch (err) {
        this.showError(err);
      }

	  this.stockList = this.products.map(p => {
		const stocks = this.inventory.filter(i => i.productCode === p.productCode);
		const total = stocks.reduce((sum, i) => sum + i.quantity, 0);
		return {
		    productCode: p.productCode,
		    stockByWarehouse: stocks.map(i => ({
		    warehouse: i.warehouse,
		    quantity: i.quantity
		  })),
		  total
		};
      });

    }
  }">

    <template v-if="page === 'login'">
      <h2>登入系統 <small v-if="isTestMode">(測試模式)</small></h2>
      <input v-model="username" type="text" placeholder="帳號" /><br />
      <input v-model="password" type="password" placeholder="密碼" /><br />
      <button @click="login" :disabled="isLoading || !username || !password">
        {{ isLoading ? '登入中...' : '登入' }}
      </button>
      <p class="message">{{ message }}</p>
    </template>

    <div v-if="page === 'dashboard'">
      <h2>歡迎 {{ username }}</h2>
      <button @click="logout">登出</button>
      <button @click="srcProducts">查詢</button>
      <p class="message">{{ message }}</p>
    
      <div v-for="item in stockList" :key="item.productCode" class="product-block">
        <details>
          <summary class="product-summary">
            商品代碼：{{ item.productCode }}
          </summary>
          <table class="stock-table">
            <thead>
              <tr>
                <th>倉別</th>
                <th>庫存數</th>
              </tr>
            </thead>
            <tbody>
              <tr v-for="s in item.stockByWarehouse" :key="s.warehouse">
                <td>{{ s.warehouse }}</td>
                <td class="text-right">{{ s.quantity }}</td>
              </tr>
            </tbody>
            <tfoot>
              <tr>
                <td class="bold">總庫存數</td>
                <td class="text-right bold">{{ item.total }}</td>
              </tr>
            </tfoot>
          </table>
        </details>
      </div>
    </div>

  </div>
</body>
</html>